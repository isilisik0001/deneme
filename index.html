<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Chat JSON</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    #wrap { display:flex; flex-direction:column; gap:12px; max-width:820px; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    #log { max-height:240px; overflow:auto; background:#f6f6f6; padding:8px; border-radius:8px; }
    small { color:#666 }
  </style>
</head>
<body>
<div id="wrap">
  <h3>Export Chat JSON</h3>

  <div id="state"><small>Durum: başlatılıyor…</small></div>

  <div>
    <button id="signin" style="display:none">LiveChat ile giriş yap (OAuth)</button>
    <button id="export" style="display:none">Bu sohbeti JSON indir</button>
  </div>

  <pre id="log"></pre>
</div>

<script src="https://unpkg.com/@livechat/agent-app-sdk/dist/agentapp.umd.min.js"></script>
<script>
(async () => {
  // ----------------- yardımcılar -----------------
  const $ = sel => document.querySelector(sel);
  const log = (m) => {
    const el = $('#log');
    el.textContent += (typeof m === 'string' ? m : JSON.stringify(m, null, 2)) + "\n";
    el.scrollTop = el.scrollHeight;
  };
  const setState = (t) => $('#state').innerHTML = `<small>${t}</small>`;

  // güvenlik: CSRF için state üret
  function randomString(n=24){
    return [...crypto.getRandomValues(new Uint8Array(n))]
      .map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const OAUTH_STATE_KEY = 'lc_oauth_state';
  if (!localStorage.getItem(OAUTH_STATE_KEY)) {
    localStorage.setItem(OAUTH_STATE_KEY, randomString());
  }
  const OAUTH_STATE = localStorage.getItem(OAUTH_STATE_KEY);

  // ----------------- Agent App SDK -----------------
  const sdk = await window.LiveChat.createDetailsWidget();

  let chatId = null;
  async function setInitialContext() {
    const ctx = await sdk.getContext();
    log({ ctx_initial: { chat_id: ctx?.chat?.id || null } });
    if (ctx?.chat?.id) {
      chatId = ctx.chat.id;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId})`);
      maybeEnableExport();
    } else {
      setState("Durum: sohbet bekleniyor…");
    }
  }
  sdk.on('chat_selected', (data) => {
    log({ chat_selected: { chat_id: data?.chat?.id || null } });
    chatId = data?.chat?.id || null;
    if (chatId) setState(`Durum: sohbet bulundu (chat_id: ${chatId})`);
    maybeEnableExport();
  });
  await setInitialContext();

  // ----------------- OAuth 2.1 (implicit) -----------------
  const CLIENT_ID   = 'e65158671dae5dad51dd7d9b3fc8d222';
  const REDIRECT_URI = 'https://deneme-ten-jade.vercel.app/'; // whitelist’e birebir ekli olmalı
  const SCOPES = encodeURIComponent('chats--access:ro chats--all:ro');

  const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
  let accessToken = hashParams.get('access_token') || null;
  const stateFromHash = hashParams.get('state') || null;
  const expiresIn = Number(hashParams.get('expires_in') || 0);

  // state doğrulaması
  if (accessToken && stateFromHash && stateFromHash !== OAUTH_STATE) {
    accessToken = null; // eşleşmiyorsa token’ı reddet
    log('Uyarı: OAuth state eşleşmedi, token reddedildi.');
  }

  // giriş butonunu hazırla
  const signInBtn = $('#signin');
  signInBtn.onclick = () => {
    const AUTH_URL =
      `https://accounts.livechat.com/oauth/authorize?response_type=token&client_id=${CLIENT_ID}` +
      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${SCOPES}&state=${OAUTH_STATE}`;
    window.location.href = AUTH_URL;
  };

  // token yoksa giriş öner
  if (!accessToken) {
    signInBtn.style.display = 'inline-block';
    setState($('#state').textContent + " – token yok → önce giriş yap");
  } else {
    setState($('#state').textContent + " – token bulundu");
  }

  // token süresi dolmadan yeniden giriş tetikle
  if (accessToken && expiresIn > 0) {
    setTimeout(() => {
      // yeni hash taşımak için tekrar authorize
      if (confirm('Oturum süren dolmak üzere. Yeniden giriş yapalım mı?')) {
        signInBtn.click();
      }
    }, Math.max(1, (expiresIn - 60)) * 1000);
  }

  // URL hash değişirse (yeniden yönlendirme sonrası) buton görünürlüğünü güncelle
  window.addEventListener('hashchange', () => maybeEnableExport());

  // ----------------- Export butonu görünürlüğü -----------------
  const exportBtn = $('#export');
  function maybeEnableExport() {
    if (chatId && (accessToken || new URLSearchParams(location.hash.slice(1)).get('access_token'))) {
      exportBtn.style.display = 'inline-block';
    } else {
      exportBtn.style.display = 'none';
    }
  }
  maybeEnableExport();

  // ----------------- API çağrıları -----------------
  async function fetchJsonOrText(res) {
    const text = await res.text();
    try { return JSON.parse(text); } catch { throw new Error(text); }
  }

  async function fetchChatJson(chatId) {
    if (!accessToken) throw new Error('access_token yok');
    if (!chatId) throw new Error('chatId yok');

    // 1) arşivden son thread id’yi almaya çalış
    let threadId = null;
    try {
      const archivesRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_archives', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filters: { chat_ids: [chatId] }, limit: 1 })
      });
      if (archivesRes.ok) {
        const archives = await archivesRes.json();
        threadId = archives?.chats?.[0]?.threads?.slice(-1)?.[0]?.id || null;
      } else {
        // arşiv hatası kritik değil; get_chat’le devam edebiliriz
        log('list_archives başarısız ama get_chat deneniyor…');
      }
    } catch(e) {
      log('list_archives çağrısı sırasında hata: ' + (e?.message || e));
    }

    // 2) threadId varsa onunla, yoksa onsuz get_chat
    const payload = threadId ? { chat_id: chatId, thread_id: threadId } : { chat_id: chatId };
    const chatRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/get_chat', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!chatRes.ok) throw new Error('get_chat hata: ' + await chatRes.text());
    const chat = await chatRes.json();

    const events = (chat?.chat?.thread?.events || chat?.chat?.events || []);
    return {
      chat_id: chatId,
      thread_id: threadId || chat?.chat?.thread?.id || null,
      users: chat?.chat?.users || [],
      properties: chat?.chat?.properties || {},
      events: events.map(e => ({
        id: e.id,
        ts: e.created_at,
        author_type: e.author?.type,
        author_id: e.author?.id,
        type: e.type,
        text: e.text,
        attachments: e.attachments || null,
        custom: e.custom_id || null
      }))
    };
  }

  // ----------------- İndir butonu -----------------
  exportBtn.onclick = async () => {
    try {
      exportBtn.disabled = true;
      exportBtn.textContent = 'İndiriliyor…';
      setState('Durum: veri çekiliyor…');

      const data = await fetchChatJson(chatId);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `chat-${data.chat_id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);

      setState('Durum: hazır – dosya indirildi');
      log({ ok: true, size: blob.size, chat_id: data.chat_id, thread_id: data.thread_id });
    } catch (err) {
      setState('Durum: hata – loga bak');
      log(err.message || err);
    } finally {
      exportBtn.disabled = false;
      exportBtn.textContent = 'Bu sohbeti JSON indir';
    }
  };
})();
</script>
</body>
</html>
