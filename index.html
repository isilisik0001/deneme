<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Chat JSON</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    #wrap { display:flex; flex-direction:column; gap:12px; max-width:820px; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    #log { max-height:240px; overflow:auto; background:#f6f6f6; padding:8px; border-radius:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    small { color:#666 }
    a.small { font-size:12px; text-decoration:underline; cursor:pointer; }
  </style>
</head>
<body>
<div id="wrap">
  <h3>Export Chat JSON</h3>

  <div id="state"><small>Durum: başlatılıyor…</small></div>

  <div class="row">
    <button id="signin">LiveChat ile giriş yap (OAuth)</button>
    <a id="resetTok" class="small">tokenı sıfırla</a>
    <button id="export" style="display:none">Bu sohbeti JSON indir</button>
  </div>

  <div class="row" id="manualRow" style="display:none">
    <input id="manualId" placeholder="chat_id" style="width:240px" />
    <button id="useManual">Set chat_id</button>
  </div>

  <pre id="log"></pre>
</div>

<script src="https://unpkg.com/@livechat/agent-app-sdk/dist/agentapp.umd.min.js"></script>
<script>
(async () => {
  const $ = s => document.querySelector(s);
  const log = m => { const el = $('#log'); el.textContent += (typeof m === 'string' ? m : JSON.stringify(m, null, 2)) + "\n"; el.scrollTop = el.scrollHeight; };
  const setState = t => $('#state').innerHTML = `<small>${t}</small>`;

  // ---------- helpers ----------
  function randomString(n=24){ return [...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function parseChatIdFromUrl(u) {
    if (!u) return null;
    const m1 = u.match(/\/chats\/[^/]+\/([A-Za-z0-9_-]+)/i);
    if (m1 && m1[1]) return m1[1];
    const m2 = u.match(/\/archives\/([A-Za-z0-9_-]+)/i);
    if (m2 && m2[1]) return m2[1];
    return null;
  }

  // ---------- OAuth CSRF state ----------
  const OAUTH_STATE_KEY = 'lc_oauth_state';
  if (!localStorage.getItem(OAUTH_STATE_KEY)) localStorage.setItem(OAUTH_STATE_KEY, randomString());
  const OAUTH_STATE = localStorage.getItem(OAUTH_STATE_KEY);

  // ---------- SDK & chat id ----------
  const sdk = await window.LiveChat.createDetailsWidget();
  let chatId = null;

  async function setInitialContext() {
    // 1) SDK'dan bağlam (varsa)
    let ctx = null;
    if (typeof window.LiveChat?.getContext === 'function') {
      try { ctx = await window.LiveChat.getContext(); } catch {}
    }
    // 2) Önceki parent URL (OAuth'a gitmeden önce kaydettiğimiz)
    const savedParent = sessionStorage.getItem('lc_parent_url') || '';
    // 3) Güncel referrer (OAuth dönüşünde accounts olabilir)
    const ref = document.referrer || '';

    const parsed =
      parseChatIdFromUrl(savedParent) ||
      parseChatIdFromUrl(ref);

    log({ saved_parent: savedParent, referrer: ref, parsed_from_saved_or_ref: parsed, ctx_initial: ctx });

    if (parsed) {
      chatId = parsed;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId})`);
      maybeEnableExport();
      return;
    }
    if (ctx?.chat?.id) {
      chatId = ctx.chat.id;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId})`);
      maybeEnableExport();
      return;
    }
    // 4) elle girme seçeneği
    setState("Durum: sohbet bekleniyor…");
    $('#manualRow').style.display = 'flex';
  }

  // chat değişimi event'leri
  const onSel = d => {
    const id = d?.chat?.id || d?.id;
    if (id) {
      chatId = id;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId}) – event`);
      maybeEnableExport();
    }
  };
  sdk.on?.('chat_selected', onSel);
  sdk.on?.('chatSelected', onSel);

  await setInitialContext();

  // ---------- OAuth ----------
  const CLIENT_ID   = 'e65158671dae5dad51dd7d9b3fc8d222';
  const REDIRECT_URI = 'https://deneme-ten-jade.vercel.app/';
  // bu iki scope App Authorization’da AÇIK olmalı
  const SCOPES = encodeURIComponent('chats--access:ro chats--all:ro');

  const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
  let accessToken = hashParams.get('access_token') || null;
  const stateFromHash = hashParams.get('state') || null;
  const expiresIn = Number(hashParams.get('expires_in') || 0);

  if (accessToken && stateFromHash && stateFromHash !== OAUTH_STATE) {
    accessToken = null;
    log('Uyarı: OAuth state eşleşmedi, token reddedildi.');
  }

  function updateStateWithToken() {
    setState($('#state').textContent.replace(/ ?– token (yok|bulundu).*/,'') + (accessToken ? ' – token bulundu' : ' – token yok → önce giriş yap'));
    maybeEnableExport();
  }
  updateStateWithToken();

  // OAuth’a gitmeden önce parent URL’i kaydet → dönüşte buradan chat_id çıkaracağız
  $('#signin').onclick = () => {
    // agent app parent url (sohbet veya arşiv sayfası)
    try { sessionStorage.setItem('lc_parent_url', document.referrer || sessionStorage.getItem('lc_parent_url') || ''); } catch {}
    const AUTH_URL =
      `https://accounts.livechat.com/oauth/authorize?response_type=token&client_id=${CLIENT_ID}` +
      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${SCOPES}&state=${OAUTH_STATE}`;
    window.location.href = AUTH_URL;
  };

  // token sıfırla
  $('#resetTok').onclick = (e) => {
    e.preventDefault();
    accessToken = null;
    location.hash = '';
    updateStateWithToken();
  };

  if (accessToken && expiresIn > 0) {
    setTimeout(() => { if (confirm('Oturum süren dolmak üzere. Yeniden giriş yapalım mı?')) $('#signin').click(); }, Math.max(1, (expiresIn - 60)) * 1000);
  }

  // ---------- export görünürlüğü ----------
  const exportBtn = $('#export');
  function maybeEnableExport() {
    const hasToken = !!(accessToken || new URLSearchParams(location.hash.slice(1)).get('access_token'));
    exportBtn.style.display = (chatId && hasToken) ? 'inline-block' : 'none';
  }

  // manuel chat_id gir
  $('#useManual').onclick = () => {
    const v = $('#manualId').value.trim();
    if (v) {
      chatId = v;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId}) – manual`);
      maybeEnableExport();
    }
  };

  // ---------- API ----------
  async function fetchChatJson(chatId) {
    if (!accessToken) throw new Error('access_token yok');
    if (!chatId) throw new Error('chatId yok');

    // Önce arşivden son thread (opsiyonel)
    let threadId = null;
    try {
      const r = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_archives', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filters: { chat_ids: [chatId] }, limit: 1 })
      });
      if (r.ok) {
        const j = await r.json();
        threadId = j?.chats?.[0]?.threads?.slice(-1)?.[0]?.id || null;
      }
    } catch(e) { log('list_archives hata: ' + (e?.message||e)); }

    // thread_id varsa onunla, yoksa onsuz
    const payload = threadId ? { chat_id: chatId, thread_id: threadId } : { chat_id: chatId_
