<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Chat JSON</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    #wrap { display:flex; flex-direction:column; gap:12px; max-width:820px; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    #log { max-height:240px; overflow:auto; background:#f6f6f6; padding:8px; border-radius:8px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    small { color:#666 }
  </style>
</head>
<body>
<div id="wrap">
  <h3>Export Chat JSON</h3>

  <div id="state"><small>Durum: başlatılıyor…</small></div>

  <div class="row">
    <button id="signin" style="display:none">LiveChat ile giriş yap (OAuth)</button>
    <button id="export" style="display:none">Bu sohbeti JSON indir</button>

    <!-- Manuel chat_id girişi (gerekirse) -->
    <input id="manualId" placeholder="chat_id" style="width:220px;display:none" />
    <button id="useManual" style="display:none">Set chat_id</button>
  </div>

  <pre id="log"></pre>
</div>

<script src="https://unpkg.com/@livechat/agent-app-sdk/dist/agentapp.umd.min.js"></script>
<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const log = m => { const el = $('#log'); el.textContent += (typeof m === 'string' ? m : JSON.stringify(m, null, 2)) + "\n"; el.scrollTop = el.scrollHeight; };
  const setState = t => $('#state').innerHTML = `<small>${t}</small>`;

  // ---- OAuth CSRF state ----
  function randomString(n=24){ return [...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join(''); }
  const OAUTH_STATE_KEY = 'lc_oauth_state';
  if (!localStorage.getItem(OAUTH_STATE_KEY)) localStorage.setItem(OAUTH_STATE_KEY, randomString());
  const OAUTH_STATE = localStorage.getItem(OAUTH_STATE_KEY);

  // ---- SDK & chat id ----
  const sdk = await window.LiveChat.createDetailsWidget();
  let chatId = null;

  function parseChatIdFromReferrer(ref) {
    // 1) /chats/<something>/<CHAT_ID>
    const mChats = ref.match(/\/chats\/[^/]+\/([A-Za-z0-9_-]+)/i);
    if (mChats && mChats[1]) return mChats[1];
    // 2) /archives/<CHAT_ID>
    const mArchives = ref.match(/\/archives\/([A-Za-z0-9_-]+)/i);
    if (mArchives && mArchives[1]) return mArchives[1];
    return null;
  }

  async function setInitialContext() {
    let ctx = null;
    if (typeof window.LiveChat?.getContext === 'function') {
      try { ctx = await window.LiveChat.getContext(); } catch(e) {}
    }

    // referrer fallback (Arşiv veya Chats)
    const ref = document.referrer || '';
    const fromRef = parseChatIdFromReferrer(ref);
    log({ referrer: ref, parsed_from_referrer: fromRef });

    if (fromRef) {
      chatId = fromRef;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId}) – referrer`);
      maybeEnableExport();
      return;
    }

    // SDK bağlamı
    log({ ctx_initial: ctx });
    if (ctx?.chat?.id) {
      chatId = ctx.chat.id;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId})`);
      maybeEnableExport();
    } else {
      setState("Durum: sohbet bekleniyor…");
      // Manuel giriş alanını aç
      $('#manualId').style.display = 'inline-block';
      $('#useManual').style.display = 'inline-block';
    }
  }

  // event ile chat değişimi
  if (sdk.on) {
    const onSel = (data) => {
      const id = data?.chat?.id || data?.id;
      if (id) {
        chatId = id;
        setState(`Durum: sohbet bulundu (chat_id: ${chatId}) – event`);
        maybeEnableExport();
      }
    };
    sdk.on('chat_selected', onSel);
    sdk.on('chatSelected', onSel);
  }

  // Manuel set
  $('#useManual').onclick = () => {
    const v = $('#manualId').value.trim();
    if (v) {
      chatId = v;
      setState(`Durum: sohbet bulundu (chat_id: ${chatId}) – manual`);
      maybeEnableExport();
    }
  };

  await setInitialContext();

  // ---- OAuth ----
  const CLIENT_ID   = 'e65158671dae5dad51dd7d9b3fc8d222';
  const REDIRECT_URI = 'https://deneme-ten-jade.vercel.app/';
  const SCOPES = encodeURIComponent('chats--access:ro chats--all:ro');

  const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
  let accessToken = hashParams.get('access_token') || null;
  const stateFromHash = hashParams.get('state') || null;
  const expiresIn = Number(hashParams.get('expires_in') || 0);

  if (accessToken && stateFromHash && stateFromHash !== OAUTH_STATE) {
    accessToken = null;
    log('Uyarı: OAuth state eşleşmedi, token reddedildi.');
  }

  const signInBtn = $('#signin');
  signInBtn.onclick = () => {
    const AUTH_URL =
      `https://accounts.livechat.com/oauth/authorize?response_type=token&client_id=${CLIENT_ID}` +
      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${SCOPES}&state=${OAUTH_STATE}`;
    window.location.href = AUTH_URL;
  };

  if (!accessToken) {
    signInBtn.style.display = 'inline-block';
    setState($('#state').textContent + " – token yok → önce giriş yap");
  } else {
    setState($('#state').textContent + " – token bulundu");
  }

  if (accessToken && expiresIn > 0) {
    setTimeout(() => { if (confirm('Oturum süren dolmak üzere. Yeniden giriş yapalım mı?')) signInBtn.click(); }, Math.max(1, (expiresIn - 60)) * 1000);
  }

  window.addEventListener('hashchange', () => maybeEnableExport());

  // ---- export görünürlüğü ----
  const exportBtn = $('#export');
  function maybeEnableExport() {
    const hasToken = !!(accessToken || new URLSearchParams(location.hash.slice(1)).get('access_token'));
    exportBtn.style.display = (chatId && hasToken) ? 'inline-block' : 'none';
  }
  maybeEnableExport();

  // ---- API çağrısı ----
  async function fetchChatJson(chatId) {
    if (!accessToken) throw new Error('access_token yok');
    if (!chatId) throw new Error('chatId yok');

    let threadId = null;
    try {
      const archivesRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_archives', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filters: { chat_ids: [chatId] }, limit: 1 })
      });
      if (archivesRes.ok) {
        const archives = await archivesRes.json();
        threadId = archives?.chats?.[0]?.threads?.slice(-1)?.[0]?.id || null;
      }
    } catch(e) { log('list_archives hata: ' + (e?.message||e)); }

    const payload = threadId ? { chat_id: chatId, thread_id: threadId } : { chat_id: chatId };
    const chatRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/get_chat', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!chatRes.ok) throw new Error('get_chat hata: ' + await chatRes.text());
    const chat = await chatRes.json();

    const events = (chat?.chat?.thread?.events || chat?.chat?.events || []);
    return {
      chat_id: chatId,
      thread_id: threadId || chat?.chat?.thread?.id || null,
      users: chat?.chat?.users || [],
      properties: chat?.chat?.properties || {},
      events: events.map(e => ({
        id: e.id,
        ts: e.created_at,
        author_type: e.author?.type,
        author_id: e.author?.id,
        type: e.type,
        text: e.text,
        attachments: e.attachments || null,
        custom: e.custom_id || null
      }))
    };
  }

  // ---- indir butonu ----
  exportBtn.onclick = async () => {
    try {
      exportBtn.disabled = true;
      exportBtn.textContent = 'İndiriliyor…';
      setState('Durum: veri çekiliyor…');

      const data = await fetchChatJson(chatId);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `chat-${data.chat_id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);

      setState('Durum: hazır – dosya indirildi');
      log({ ok: true, size: blob.size, chat_id: data.chat_id, thread_id: data.thread_id });
    } catch (err) {
      setState('Durum: hata – loga bak');
      log(err.message || err);
    } finally {
      exportBtn.disabled = false;
      exportBtn.textContent = 'Bu sohbeti JSON indir';
    }
  };
})();
</script>
</body>
</html>
