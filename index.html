<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Chat JSON</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    #wrap { display:flex; flex-direction:column; gap:12px; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    #log { max-height:220px; overflow:auto; background:#f6f6f6; padding:8px; border-radius:8px; }
    small { color:#666 }
  </style>
</head>
<body>
<div id="wrap">
  <h3>Export Chat JSON</h3>

  <div id="state"><small>Durum: başlatılıyor…</small></div>

  <div>
    <button id="signin" style="display:none">LiveChat ile giriş yap (OAuth)</button>
    <button id="export" style="display:none">Bu sohbeti JSON indir</button>
  </div>

  <pre id="log"></pre>
</div>

<script src="https://unpkg.com/@livechat/agent-app-sdk/dist/agentapp.umd.min.js"></script>
<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const log = (m) => { const el = $('#log'); el.textContent += (typeof m === 'string' ? m : JSON.stringify(m, null, 2)) + "\n"; };

  // 1) Agent App SDK: Chat Details widget olarak bağlan
  const sdk = await window.LiveChat.createDetailsWidget();

  // --- CHAT CONTEXT ---
  let chatId = null;

  async function setInitialContext() {
    const ctx = await sdk.getContext();
    log({ ctx_initial: ctx });
    if (ctx?.chat?.id) {
      chatId = ctx.chat.id;
      $('#state').innerHTML = `<small>Durum: sohbet bulundu (chat_id: ${chatId})</small>`;
      maybeEnableExport();
    } else {
      $('#state').innerHTML = "<small>Durum: sohbet bekleniyor…</small>";
    }
  }

  // Sohbet sonradan seçilirse yakala
  sdk.on('chat_selected', (data) => {
    log({ chat_selected: data });
    chatId = data?.chat?.id || null;
    if (chatId) {
      $('#state').innerHTML = `<small>Durum: sohbet bulundu (chat_id: ${chatId})</small>`;
      maybeEnableExport();
    }
  });

  await setInitialContext();

  // --- OAUTH/TOKEN ---
  const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
  let accessToken = hashParams.get('access_token');

  // Token yoksa butonu göster (HER ZAMAN)
  const CLIENT_ID = 'e65158671dae5dad51dd7d9b3fc8d222';
  const REDIRECT_URI = 'https://deneme-ten-jade.vercel.app/';
  const SCOPES = encodeURIComponent('chats--access:ro chats--all:ro'); // sende all:ro da açık

  if (!accessToken) {
    $('#signin').style.display = 'inline-block';
    $('#signin').onclick = () => {
      const AUTH_URL =
        `https://accounts.livechat.com/oauth/authorize?response_type=token&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${SCOPES}`;
      window.location.href = AUTH_URL;
    };
    $('#state').innerHTML += " – <small>token yok → önce giriş yap</small>";
  } else {
    $('#state').innerHTML += " – <small>token bulundu</small>";
  }

  // İki şart tamamlanınca Export’u aç
  function maybeEnableExport() {
    if (chatId && accessToken) {
      $('#export').style.display = 'inline-block';
    } else {
      $('#export').style.display = 'none';
    }
  }
  maybeEnableExport();

  // --- API: Sohbeti çek ---
  async function fetchChatJson(chatId) {
    if (!accessToken) throw new Error('access_token yok');
    if (!chatId) throw new Error('chatId yok');
    const archivesRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_archives', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ filters: { chat_ids: [chatId] }, limit: 1 })
    });
    if (!archivesRes.ok) throw new Error('list_archives hata: ' + await archivesRes.text());
    const archives = await archivesRes.json();

    const threadId = archives?.chats?.[0]?.threads?.slice(-1)?.[0]?.id || null;

    const chatRes = await fetch('https://api.livechatinc.com/v3.5/agent/action/get_chat', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, thread_id: threadId })
    });
    if (!chatRes.ok) throw new Error('get_chat hata: ' + await chatRes.text());
    const chat = await chatRes.json();

    return {
      chat_id: chatId,
      thread_id: threadId,
      users: chat?.chat?.users || [],
      properties: chat?.chat?.properties || {},
      events: (chat?.chat?.thread?.events || []).map(e => ({
        id: e.id,
        ts: e.created_at,
        author_type: e.author?.type,
        author_id: e.author?.id,
        type: e.type,
        text: e.text,
        attachments: e.attachments || null,
        custom: e.custom_id || null
      }))
    };
  }

  // --- İndir butonu ---
  $('#export').onclick = async () => {
    try {
      $('#state').innerHTML = "<small>Durum: veri çekiliyor…</small>";
      const data = await fetchChatJson(chatId);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `chat-${data.chat_id}.json`;
      a.click();
      $('#state').innerHTML = "<small>Durum: hazır – dosya indirildi</small>";
      log({ ok: true, size: blob.size });
    } catch (err) {
      $('#state').innerHTML = "<small>Durum: hata – konsola bak</small>";
      log(err.message || err);
    }
  };
})();
</script>
</body>
</html>

